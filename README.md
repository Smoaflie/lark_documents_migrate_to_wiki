# 飞书云文档迁移到知识库工具

本项目用于在浏览器内完成飞书云文档的选择、复制与迁移到知识库，并展示完整的接口请求/响应日志。适合在本地快速验证应用权限、用户授权与迁移流程。

## 功能概览

- 一键完成 tenant_access_token 与 user_access_token 获取（OAuth 授权流程）
- 获取我的空间根目录元数据与共享文件夹元数据
- 树状展示文件夹内容，支持手动展开、单根目录选择与半选状态
- 将选中文档复制到“我的空间”根目录下的 `<根文件夹名>_to_migrate`
- 将复制后的文档迁移到新建知识库空间
- 迁移时提供步骤条与进度条，支持主动停止
- 迁移接口限流：每 90 次请求自动暂停 60 秒并提示等待
- 迁移完成后在结果窗口提示手动删除 `_to_migrate` 文件夹

## 运行要求

- Node.js 18+（内置 fetch）
- 飞书开放平台自建应用（已开通云文档/知识库相关权限）

## 快速开始

1) 启动服务

```bash
node server.js
```

2) 打开页面  
浏览器访问 `http://localhost:3000`

3) 在飞书开发者后台中新建应用，进行如下配置：

  1) `凭证与基础信息`: 获取 `APP_ID` 与 `APP_SECRET`

  2) `权限管理`: 批量导入如下权限：

    ```json
    {
      "scopes": {
        "tenant": [],
        "user": [
          "docs:document:copy",
          "drive:drive",
          "drive:drive.metadata:readonly",
          "space:folder:create",
          "wiki:wiki"
        ]
      }
    }
    ```

  3) `安全设置`: 配置重定向URL  
    填写：`http://localhost:3000/oauth/callback`

  4) 发布应用


## 操作指南

### 1. 一键授权并加载根目录

1) 输入 `APP_ID`、`APP_SECRET`，设置 `OAuth 权限范围`（建议包含云文档与知识库相关权限）。  
2) 点击 “一键授权并加载根目录”，按提示完成授权。  
3) 授权完成后会自动获取根目录信息，并加入文件树。

### 2. 添加共享文件夹（可选）

输入 `Folder Token`，点击 “添加到文件树”，系统会自动获取文件夹名称。

需要重新拉取个人空间或共享文件夹信息时，可点击文件树右上角“刷新”。

### 3. 浏览与选择

- 展开文件夹会加载其子项。
- 选择规则：
  - 每次只能选择同一个根目录下的内容。
  - 选中文件夹会自动选中其子文件/子文件夹。
  - 部分选中时父级呈现半选状态。

### 4. 迁移到知识库

点击 “开始迁移”，流程如下：

1) 校验选择范围  
2) 读取选中根目录名称  
3) 在“我的空间”根目录创建 `<根文件夹名>_to_migrate`  
4) 将选中文档复制到 `_to_migrate`  
5) 校验复制完成情况  
6) 以根目录名称创建知识空间  
7) 用同名 docx 模拟子文件夹  
8) 按顺序移动文档到知识库  
9) 可选查询迁移任务结果  
10) 迁移完成后在结果窗口提示手动删除 `_to_migrate` 文件夹

迁移中会展示步骤条与进度条，并在日志框内输出所有接口请求/响应与错误信息。

### 5. 主动停止

点击 “停止迁移” 可中止当前迁移流程。取消后会在日志中提示。

## 常见问题

### 为什么看不到 `_to_migrate`？

当前实现会在“我的空间”根目录下创建 `_to_migrate`。如果没有看到，通常是：

- user_access_token 失效或权限不足  
- 接口调用失败（可查看日志与返回信息）  

## 注意事项

- 日志中会包含接口响应与 token，请注意隐私保护。
- 迁移接口有频率限制，系统会在每 90 次请求后自动暂停 60 秒。
- 若需要更高频迁移，请评估飞书开放平台的限制策略与企业级配额。
